<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ğŸ“Š LSA Tool (Frontend)</title>
  <meta name="description" content="Liquidity & Solvency Analysis â€“ GitHub Pages frontend calling FastAPI backend" />
  <!-- Optional Markdown renderer for nicer narrative -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    :root {
      --bg:#0f1117; --card:#111827; --text:#e5e7eb; --muted:#9ca3af; --border:#334155;
    }
    html,body{background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;padding:0}
    .wrap{max-width:980px;margin:0 auto;padding:24px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;margin-top:16px;box-shadow:0 4px 20px rgba(0,0,0,.25)}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    input,select,button{padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:var(--card);color:var(--text)}
    button{cursor:pointer}
    .muted{color:var(--muted);font-size:13px}
    .grid{display:grid;gap:12px}
    .grid-3{grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
    .ratio{border:1px solid var(--border);border-radius:12px;padding:12px}
    .badge{display:inline-block;padding:4px 10px;border-radius:999px;background:#334155;font-size:12px;margin-left:6px}
    .badge.Strong{background:#10b981}
    .badge.Fair{background:#f59e0b}
    .badge.Weak{background:#ef4444}
    pre{white-space:pre-wrap;background:#0b1220;padding:12px;border-radius:12px;overflow:auto}
    a { color: #93c5fd; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ğŸ“Š LSA Tool</h1>
    <p class="muted">GitHub Pages ì •ì  í”„ë¡ íŠ¸ì—ì„œ FastAPI ë°±ì—”ë“œ(API)ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.</p>

    <div class="card">
      <div class="row" style="align-items:center">
        <input id="ticker" placeholder="AAPL / 005930.KS / 7203.T" style="flex:1" />
        <select id="lang">
          <option value="ko">í•œêµ­ì–´</option>
          <option value="en">English</option>
        </select>
        <button id="go">ğŸ” Analyse</button>
      </div>
      <p class="muted" style="margin-top:8px">KR/JP/HK ì¢…ëª©ì€ .KS / .T / .HK ì ‘ë¯¸ì‚¬ë¥¼ ë¶™ì—¬ì£¼ì„¸ìš”.</p>
      <p class="muted">API ìƒíƒœ: <span id="health">í™•ì¸ ì¤‘â€¦</span></p>
    </div>

    <div id="out" class="card" style="display:none">
      <h2 id="title">ê²°ê³¼</h2>
      <div id="meta" class="muted" style="margin-bottom:8px"></div>

      <h3>ğŸ’§ Liquidity</h3>
      <div id="liq" class="grid grid-3"></div>
      <h3>ğŸ›¡ï¸ Solvency</h3>
      <div id="sol" class="grid grid-3"></div>

      <h3>ğŸ“ Narrative</h3>
      <div id="narr" class="muted"></div>

      <details style="margin-top:12px">
        <summary>Raw JSON</summary>
        <pre id="raw"></pre>
      </details>
    </div>
  </div>

  <script>
    // ğŸ”§ ë°°í¬í•œ FastAPI ë°±ì—”ë“œ ì£¼ì†Œë¡œ ë°”ê¿”ì£¼ì„¸ìš”
    const API_BASE = "https://chanthr-github-io.onrender.com"; // â† ì—¬ê¸¸ ë³¸ì¸ Render URLë¡œ

    const $ = s => document.querySelector(s);
    const goBtn = $("#go");

    // ê°„ë‹¨í•œ í—¬ìŠ¤ì²´í¬
    async function checkHealth(){
      try{
        const r = await fetch(`${API_BASE}/health`, {cache:'no-store'});
        const data = await r.json();
        $("#health").textContent = data?.status === 'ok' ? 'OK' : 'ì˜¤ë¥˜';
      }catch(e){ $("#health").textContent = 'ì ‘ì† ì‹¤íŒ¨'; }
    }
    checkHealth();

    function ratioCard(title, node){
      if(!node) return '';
      const value = (node.value==null)? 'N/A' : Number(node.value).toFixed(2);
      const band = node.band || 'N/A';
      return `<div class="ratio"><div><strong>${title}</strong> <span class="badge ${band}">${band}</span></div>
              <div style="margin-top:6px">Value: ${value}</div></div>`;
    }

    async function analyse(){
      const t = $("#ticker").value.trim().toUpperCase();
      const lang = $("#lang").value;
      if(!t){ alert('í‹°ì»¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); return; }
      goBtn.disabled = true; goBtn.textContent = 'â³ Analyzing...';
      $("#out").style.display = 'none';
      try{
        const res = await fetch(`${API_BASE}/analyse`,{
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ query: `${t} ìœ ë™ì„±/ê±´ì „ì„± í‰ê°€`, language: lang })
        });
        if(!res.ok){ throw new Error(`HTTP ${res.status}`); }
        const data = await res.json();

        // í—¤ë”/ë©”íƒ€
        $("#title").textContent = `${data.core?.company||'-'} (${data.core?.ticker||'-'})`;
        $("#meta").textContent = `Last Price: ${data.core?.price ?? 'N/A'}  â€¢  Source: ${data.meta?.source || '-'}`;

        // ë¹„ìœ¨ ì¹´ë“œ
        const liq = data.core?.ratios?.Liquidity || {};
        const sol = data.core?.ratios?.Solvency || {};
        $("#liq").innerHTML = [
          ratioCard('Current Ratio', liq.current_ratio),
          ratioCard('Quick Ratio', liq.quick_ratio),
          ratioCard('Cash Ratio', liq.cash_ratio)
        ].join('');
        $("#sol").innerHTML = [
          ratioCard('Debt-to-Equity', sol.debt_to_equity),
          ratioCard('Debt Ratio', sol.debt_ratio),
          ratioCard('Interest Coverage', sol.interest_coverage)
        ].join('');

        // ë‚´ëŸ¬í‹°ë¸Œ Markdown ë Œë”(ì—†ìœ¼ë©´ í”„ë¦¬í…ìŠ¤íŠ¸)
        const md = (data.explanation || '').trim();
        if(window.marked){ $("#narr").innerHTML = marked.parse(md); }
        else { $("#narr").textContent = md; }

        // Raw
        $("#raw").textContent = JSON.stringify(data, null, 2);
        $("#out").style.display = 'block';
      }catch(e){
        alert('ë¶„ì„ ì‹¤íŒ¨: '+ e.message + '\n(API_BASE í™•ì¸ ë° /health ì²´í¬)');
      }finally{
        goBtn.disabled = false; goBtn.textContent = 'ğŸ” Analyse';
      }
    }

    goBtn.addEventListener('click', analyse);
    // Enter í‚¤ë¡œ ì‹¤í–‰
    $("#ticker").addEventListener('keydown', (e)=>{ if(e.key==='Enter') analyse(); });
  </script>
</body>
</html>
