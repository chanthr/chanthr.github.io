<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>📊 LSA Tool (Frontend)</title>
  <meta name="description" content="Liquidity & Solvency Analysis – GitHub Pages frontend calling FastAPI backend" />
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    :root { --bg:#0f1117; --card:#111827; --text:#e5e7eb; --muted:#9ca3af; --border:#334155; }
    html,body{background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0}
    a{color:#93c5fd}

    /* Layout */
    .layout{display:grid;grid-template-columns:280px 1fr;min-height:100vh}
    @media (max-width: 900px){ .layout{grid-template-columns:1fr} .sidebar{position:fixed;inset:0 30% 0 0;transform:translateX(-100%);transition:transform .2s ease;z-index:50} .sidebar.open{transform:translateX(0)} .sidebar-backdrop{position:fixed;inset:0;backdrop-filter:blur(2px);background:rgba(0,0,0,.4);display:none;z-index:40} .sidebar.open + .sidebar-backdrop{display:block} }

    /* Sidebar (toolbar) */
    .sidebar{background:#0b1220;border-right:1px solid var(--border);padding:16px}
    .brand{display:flex;align-items:center;gap:8px;margin-bottom:12px}
    .muted{color:var(--muted);font-size:13px}
    .sep{height:1px;background:var(--border);margin:12px 0}
    .side-item{margin-bottom:10px}
    input,select,button{padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#0f1526;color:var(--text)}
    button{cursor:pointer}
    .btn-primary{background:#1f2937;border-color:#374151}

    /* Top bar (mobile) */
    .topbar{display:none;position:sticky;top:0;background:rgba(15,17,23,.85);backdrop-filter:blur(6px);border-bottom:1px solid var(--border);z-index:30}
    .topbar-inner{display:flex;align-items:center;gap:8px;padding:10px 14px}
    @media (max-width:900px){ .topbar{display:block} }

    /* Content */
    .content{padding:20px}
    .wrap{max-width:1100px;margin:0 auto}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;margin-top:16px;box-shadow:0 4px 20px rgba(0,0,0,.25)}
    .grid{display:grid;gap:12px}
    .grid-3{grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
    .ratio{border:1px solid var(--border);border-radius:12px;padding:12px}
    .badge{display:inline-block;padding:4px 10px;border-radius:999px;background:#334155;font-size:12px;margin-left:6px}
    .badge.Strong{background:#10b981}
    .badge.Fair{background:#f59e0b}
    .badge.Weak{background:#ef4444}
    pre{white-space:pre-wrap;background:#0b1220;padding:12px;border-radius:12px;overflow:auto}

    /* Floating settings button (mobile) */
    .fab{display:none;position:fixed;right:16px;bottom:16px;background:#1f2937;border:1px solid var(--border);padding:10px 12px;border-radius:10px;z-index:60}
    @media (max-width:900px){ .fab{display:block} }

    /* Spinner */
    .spinner{display:none;position:fixed;inset:0;align-items:center;justify-content:center;background:rgba(0,0,0,.35);z-index:70}
    .spinner.show{display:flex}
  </style>
</head>
<body>
  <!-- Mobile top bar -->
  <div class="topbar">
    <div class="topbar-inner">
      <button id="openSidebar">☰</button>
      <strong>📊 LSA Tool</strong>
      <span id="healthTop" class="muted" style="margin-left:auto">상태 확인 중…</span>
    </div>
  </div>

  <div class="layout">
    <!-- Sidebar / Toolbar -->
    <aside id="sidebar" class="sidebar">
      <div class="brand"><span>📊</span><strong>LSA Tool</strong></div>
      <div class="muted">GitHub Pages 프론트 → FastAPI 백엔드 호출</div>
      <div class="sep"></div>

      <label class="side-item muted">API 상태</label>
      <div class="side-item"><span id="health">확인 중…</span></div>

      <div class="sep"></div>

      <label class="side-item muted">Language</label>
      <select id="lang" class="side-item">
        <option value="ko">한국어</option>
        <option value="en">English</option>
      </select>

      <label class="side-item muted">Ticker</label>
      <input id="ticker" class="side-item" placeholder="AAPL / 005930.KS / 7203.T" />

      <div class="side-item">
        <input type="checkbox" id="showJson" /> <label for="showJson">Show JSON</label>
      </div>

      <button id="go" class="btn-primary side-item">🔄 Re-Analyse</button>

      <div class="sep"></div>
      <div class="muted">KR/JP/HK 종목은 .KS / .T / .HK 접미사를 붙여주세요.</div>
    </aside>
    <div class="sidebar-backdrop" id="backdrop"></div>

    <!-- Main content -->
    <main class="content">
      <div class="wrap">
        <div class="card">
          <h1 style="margin:0 0 4px 0">결과</h1>
          <div id="meta" class="muted">Ready.</div>
        </div>

        <div id="out" class="card" style="display:none">
          <h2 id="title" style="margin-top:0">—</h2>
          <div class="muted" style="margin-bottom:8px" id="priceSrc"></div>

          <h3>💧 Liquidity</h3>
          <div id="liq" class="grid grid-3"></div>
          <h3>🛡️ Solvency</h3>
          <div id="sol" class="grid grid-3"></div>

          <h3>📝 Narrative</h3>
          <div id="narr" class="muted"></div>

          <details id="rawWrap" style="margin-top:12px;display:none">
            <summary>Raw JSON</summary>
            <pre id="raw"></pre>
          </details>
        </div>
      </div>
    </main>
  </div>

  <button class="fab" id="fab">⚙️</button>
  <div class="spinner" id="spinner"><div class="card">⏳ Analyzing…</div></div>

  <script>
    // 🔧 배포한 FastAPI 백엔드 주소
    const API_BASE = "https://chanthr-github-io.onrender.com"; // Render URL

    const $ = s => document.querySelector(s);
    const sidebar = $("#sidebar"), backdrop=$("#backdrop"), fab=$("#fab"), openBtn=$("#openSidebar");

    // Sidebar toggles (mobile)
    function openSide(){ sidebar.classList.add('open'); }
    function closeSide(){ sidebar.classList.remove('open'); }
    if(openBtn) openBtn.onclick=openSide; if(backdrop) backdrop.onclick=closeSide; if(fab) fab.onclick=openSide;

    // Health check
    async function checkHealth(){
      try{ const r = await fetch(`${API_BASE}/health`, {cache:'no-store'}); const d = await r.json();
        $("#health").textContent = d?.status==='ok' ? 'OK' : '오류';
        $("#healthTop").textContent = d?.status==='ok' ? 'OK' : '오류';
      }catch{ $("#health").textContent='접속 실패'; $("#healthTop").textContent='접속 실패'; }
    }
    checkHealth();

    function ratioCard(title, node){
      if(!node) return '';
      const value = (node.value==null)? 'N/A' : Number(node.value).toFixed(2);
      const band = node.band || 'N/A';
      return `<div class="ratio"><div><strong>${title}</strong> <span class="badge ${band}">${band}</span></div>
              <div style="margin-top:6px">Value: ${value}</div></div>`;
    }

    async function analyse(){
      const t = $("#ticker").value.trim().toUpperCase();
      const lang = $("#lang").value;
      const showJson = $("#showJson").checked;
      if(!t){ alert('티커를 입력하세요.'); return; }
      $("#spinner").classList.add('show');
      try{
        const res = await fetch(`${API_BASE}/analyse`,{
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ query: `${t} 유동성/건전성 평가`, language: lang })
        });
        if(!res.ok){ throw new Error(`HTTP ${res.status}`); }
        const data = await res.json();

        $("#title").textContent = `${data.core?.company||'-'} (${data.core?.ticker||'-'})`;
        $("#priceSrc").textContent = `Last Price: ${data.core?.price ?? 'N/A'} • Source: ${data.meta?.source || '-'}`;

        const liq = data.core?.ratios?.Liquidity || {}; const sol = data.core?.ratios?.Solvency || {};
        $("#liq").innerHTML = [ratioCard('Current Ratio', liq.current_ratio), ratioCard('Quick Ratio', liq.quick_ratio), ratioCard('Cash Ratio', liq.cash_ratio)].join('');
        $("#sol").innerHTML = [ratioCard('Debt-to-Equity', sol.debt_to_equity), ratioCard('Debt Ratio', sol.debt_ratio), ratioCard('Interest Coverage', sol.interest_coverage)].join('');

        const md = (data.explanation || '').trim();
        if(window.marked){ $("#narr").innerHTML = marked.parse(md); } else { $("#narr").textContent = md; }

        $("#raw").textContent = JSON.stringify(data, null, 2);
        $("#rawWrap").style.display = showJson ? 'block':'none';
        $("#out").style.display = 'block';
        $("#meta").textContent = 'Ready.';
      }catch(e){ alert('분석 실패: '+ e.message + '
(API_BASE 확인 및 /health 체크)'); }
      finally{ $("#spinner").classList.remove('show'); closeSide(); }
    }

    $("#go").addEventListener('click', analyse);
    $("#ticker").addEventListener('keydown', e=>{ if(e.key==='Enter') analyse(); });
  </script>
</body>
</html>
